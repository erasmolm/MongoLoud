<!DOCTYPE html>
<html>

<head>
<!-- CSS della pagina-->
<link rel="stylesheet" type="text/css" href="/topnav.css">
<link rel="stylesheet" type="text/css" href="/login.css">
<!-- richiamo le librerie socket.io e jQuery dalle CDN (Content Delivery Network) -->

<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

<script>
    var timeout;
    var socket = io.connect('http://localhost:4301');
    socket.on('connect', function(){
        $('document').keydown(function(e){
         if(e.which == 13){
          $('#entra').click();
         }
    });
        $('#entra').click(function(){
            username = $('#uname').val();
            if(username === null || username===''){
                alert("inserisci un username");
            }else{
            $('#id01').hide();
            socket.emit('adduser', username);
            }
            });             
        });    

    socket.on('updatechat', function(username, data,value){
        if(value === true){
            $('#conversation').empty();
            $('#conversation').append('<b>' + username + ': </b>' + data + '<br>');
        }else{
            $('#conversation').append('<b>' + username + ': </b>' + data + '<br>');
        }
    });

    socket.on('updateusers', function(data){
        $('#users').empty();
        $.each(data, function(key, value){
            $('#users').append('<div>' + key + '</div>');
        });
    });


   var source = new EventSource("../testo");
        source.onmessage = function(event){
            $('#testo').html('');
            var data = JSON.parse(event.data);
            $('#testo').html(data);
        }

    socket.on('updaterooms', function(rooms, current_room) {
        $('#rooms').empty();
        $.each(rooms, function(key, value) {
            if(value == current_room){
                $('#rooms').append('<div>' + value + '</div>');
            }
            else {
                $('#rooms').append('<div><a href="#" onclick="switchRoom(\''+value+'\')">' + value + '</a></div>');
                source.close();
                source = new EventSource("../testo");
                source.onmessage = function(event){
                 $('#testo').html('');
                var data = JSON.parse(event.data);
                $('#testo').html(data);
        }

            }
        });
    });

    socket.on('typing', function(data){
        $('#typing_on').html(data);
    });


    $(document).ready(function(){

        document.getElementById('id01').style.display='block';
        //disabilito l'uso di invio altrimenti mi ripropone di nuovo la form
        $(window).keydown(function(event){
            if(event.keyCode == 13) {
             event.preventDefault();
             return false;
             }
        });

        $('#send').click(function(){
            var message = $('#data').val();
            $('#data').val('');
            socket.emit('send', message);
        });

        $('#data').keyup(function(){
            console.log("Qualcuno sta scrivendo");
            socket.emit('isTyping', 'Qualcuno sta scrivendo');
            clearTimeout(timeout);
            timeout = setTimeout(timeoutFunction, 2000);
        });
    });
   
    function disableEnter(element){
        return false;
    }

    function timeoutFunction(){
        socket.emit("isTyping", "Nessuno sta scrivendo");
    }

    function switchRoom(room){
        socket.emit('switchRoom', room);
    }

    //////////////////////////////////////
    //funzioni di gestione della pagina //
    //////////////////////////////////////

    /**
     * Selezione stazione da ascoltare
     */
    function changeStation(stazione){
        switchRoom(stazione);// TODO:
        var pl = document.getElementById("myPlayer");
        pl.src = "http://localhost:8000/" + stazione;
    }

</script>

</head>

<body>
<!-- TOPNAV -->
<div class="topnav">
	<a href="index.html">Home</a>
	<a class="active" href="radio.html">Radio</a>
	<a href="bacheca.html">Bacheca</a>
	<a href="upload.html">Upload</a>
</div>

<!-- SEZIONE RADIO -->
<div id="radio" class="divRadio">

    <!-- SOTTOSEZIONE PLAYER -->
	<h3>Seleziona la stazione che preferisci ascoltare</h3>
    <button onclick="changeStation('stazione1')">Stazione1</button>
    <button onclick="changeStation('stazione2')">Stazione2</button>
    <button onclick="changeStation('stazione3')">Stazione3</button>
    <br><br>
    <audio id="myPlayer" src="#" type="audio/mpeg" autoplay="" controls="" style="height: 40px; width: 30%;" />
    <br><br>
</div>

<!-- SOTTOSEZIONE CHAT -->
<h3>Chatroom della stazione radio</h3>
<div style="float:left;width:100px;border-right:1px solid black;height:300px;padding:10px;overflow:scroll-y;">
    <b>ROOMS</b>
    <div id="rooms"></div>
</div>
<div style="float:left;width:100px;border-right:1px solid black;height:300px;padding:10px;overflow:scroll-y;">
    <b>Utenti in ascolto</b>
    <div id="users"></div>
</div>
<div style="float:left;width:300px;height:250px;overflow:scroll-y;padding:10px;">
    <div id="conversation"></div>
    <input id="data" style="width:200px;" />
    <div id="typing_on">Nessuno sta scrivendo</div>
    <div id="testo"></div>
    <input type="button" id="send" value="invia"/>
</div>

<!-- LOGIN -->

<div id="id01" class="modal">
   <form class="modal-content animate"> 
      <div class="imgcontainer">
        <img src="./MongoLoud.png" alt="mongoloud" class="avatar">
      </div>
      <div class="container">
        <label for="uname"><b>Username</b></label>
        <input type="text" placeholder="Inserisci uno username" id="uname" required>
        <input type="button" id="entra" value="entra"/>
      </div>
    </form>
  </div>

</body>
</html>
