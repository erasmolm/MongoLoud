<!DOCTYPE html>
<html>

<head>

	<!-- CSS della pagina-->
	<link rel="stylesheet" type="text/css" href="/topnav.css">
	<link rel="stylesheet" type="text/css" href="/likes.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://cdn.socket.io/socket.io-1.2.0.js"></script>

	<script>

		///////////////////////////////////////
		//funzioni di gestione della bacheca //
		///////////////////////////////////////

        /**
         * URL del server a cui inviare la GET
         */
		let fileURL = "http://localhost:4300/files/";
		let trackURL = "http://localhost:4300/tracks/";

        /**
         * Lista dei record dei file
         */
		let fileList;

        /**
         * Effettua una GET della tracklist
         */
		function showTracklist() {

			$.get(fileURL, function (data, status) {

				//OTTIENI ELEMENTO TRACKLIST
				var list = document.getElementById("tracklist");
				list.id = "trackList";

				var i = 0;
				for (i; i < data.length; i++) {

					//CREA LIST ITEM
					var item = document.createElement("li");
					item.textContent = data[i].uploader + " ha condiviso " + data[i].filename;

					//CREA OGGETTO p PER CONTEGGIO LIKE
					var counter = document.createElement("p");
					counter.id = "counter" + data[i]._id;
					counter.innerText = "likes: " + data[i].likeCounter;
					item.appendChild(counter);

					//AGGIUNGI PLAYER
					var audio = document.createElement("audio");
					audio.id = "audio-player" + i;
					audio.controls = true;
					audio.addEventListener("play", function () {
						$("audio").not("#" + this.id).each(function () {
							this.pause();
						});
					});
					audio.src = trackURL + data[i]._id;
					audio.preload = "none";
					audio.type = "audio/mpeg";
					item.appendChild(audio);

					//AGGIUNGI LIKE/DISLIKE
					var likes = document.createElement("i");
					var dislikes = document.createElement("i");
					likes.id = "like" + data[i]._id;
					dislikes.id = "dislike" + data[i]._id;
					likes.className = "fa fa-thumbs-up";
					dislikes.className = "fa fa-thumbs-down";
					// if (localStorage.getItem(data[i]._id) === null) {
					// 	sessionStorage.setItem(data[i]._id, 0);
					// }
					item.appendChild(likes);
					item.appendChild(dislikes);

					//AGGIUNGI ITEM ALLA LISTA
					list.appendChild(item);
				}
				initLikes();

			}, "json");

		}

		function initLikes() {
			console.log("\n\n\n initLikes");
			$("i.fa.fa-thumbs-up").each(function () {
				var trackID = this.id;
				trackID = trackID.slice(-24);

				liked = sessionStorage.getItem(trackID);
				console.log("liked: " + liked)

				if (liked == 1) {
					console.log("like 1 id: " + trackID);
					$('#like' + trackID).css("pointer-events", "none");
				} else if (liked == -1) {
					console.log("like 2 id: " + trackID);
					$('#like' + trackID).css("pointer-events", "auto");
				} else if (liked == 0) {
					console.log("like 3 id: " + trackID);
					$('#like' + trackID).css("pointer-events", "auto");
				} else {
					console.log("like 4 id: " + trackID);
				}
			});
			$("i.fa.fa-thumbs-down").each(function () {
				var trackID = this.id;
				trackID = trackID.slice(-24);

				liked = sessionStorage.getItem(trackID);

				if (liked == 1) {
					console.log("dislike 1 id: " + trackID);
					$('#dislike' + trackID).css("pointer-events", "auto");
				} else if (liked == -1) {
					console.log("dislike 2 id: " + trackID);
					$('#dislike' + trackID).css("pointer-events", "none");
				} else if (liked == 0) {
					console.log("dislike 3 id: " + trackID);
					$('#dislike' + trackID).css("pointer-events", "auto");
				} else {
					console.log("dislike 4 id: " + trackID);
				}
			});

		}

		var socket = io.connect('http://localhost:4301');

		socket.on('connect', function () {
			$('i').click(function () {
				var buttonType = this.id;
				buttonType = buttonType.slice(0, -24);
				var trackID = this.id;
				trackID = trackID.slice(-24);
				liked = sessionStorage.getItem(trackID);

				if (buttonType === "like") {
					console.log("click 1");
					$('#like' + trackID).css("pointer-events", "none");
					$('#dislike' + trackID).css("pointer-events", "auto");
					//sessionStorage.setItem(trackID, liked + 1);
					liked = liked + 1;
					sessionStorage[trackID] = liked;
					socket.emit('like', trackID);
				} else if (buttonType === "dislike") {
					console.log("click 2");
					$('#dislike' + trackID).css("pointer-events", "none");
					$('#like' + trackID).css("pointer-events", "auto");
					//sessionStorage.setItem(trackID, liked - 1);
					liked = liked - 1;
					sessionStorage[trackID] = liked;
					socket.emit('dislike', trackID);
				}
			});
		});

		socket.on("updateLikes", function (id, cont) {
			$("#counter" + id).text("likes: " + cont);
		});

		$(document).ready(function () {
			showTracklist();
		});

	</script>

</head>

<body>

	<!-- TOPNAV -->
	<div class="topnav">
		<a href="index.html">Home</a>
		<a href="radio.html">Radio</a>
		<a class="active" href="bacheca.html">Bacheca</a>
		<a href="upload.html">Upload</a>
	</div>

	<div id="bacheca">
		<ul id="tracklist"></ul>
	</div>

</body>

</html>